<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Lowell zoning</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.11.0/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.11.0/mapbox-gl.js"></script>
    <style>
        html,
        body {
            margin: 0;
            padding: 0;
            height: 100%;
            width: 100%;
        }

        body {
            display: flex;
            flex-direction: column;
        }

        #map {
            flex-grow: 1;
            min-height: 0;
            width: 100%;
        }

        .mapboxgl-popup {
            width: 175px;
            font: 12px/20px 'Roboto', sans-serif;
            background-color: #425A70;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            z-index: 9999;
            display: block;
            padding: 0;
            margin: 0;
        }

        .mapboxgl-popup .mapboxgl-popup-tip {
            display: none;
        }

        .mapboxgl-popup-close-button {
            top: 2px;
            right: 4px;
            width: 7px;
            height: 7px;
            color: #fff;
        }

        .mapboxgl-popup-header {
            margin: 0px;
            font-size: 14px;
            color: #fff;
            font-weight: bold;
            padding: 5px;
        }

        .mapboxgl-popup-content {
            font-size: 12px;
            color: black;
            margin-left: 0px;
            padding: 8px;
            background-color: #fff;
            line-height: 1.25;
        }
    </style>
</head>

<body>

    <style>
        #layer-controls {
            position: absolute;
            top: 10px;
            left: 10px;
            background: white;
            padding: 10px;
            font: 14px Arial;
            z-index: 2;
            border-radius: 4px;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.2);
        }

        #legend-container {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 250px;
            /* adjust if you want wider */
            background: white;
            border-radius: 6px;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.3);
            padding: 10px;
            overflow-y: auto;
            /* scroll if too many */
            max-height: 80vh;
            /* don't overflow screen */
            z-index: 3;
            font-family: 'Helvetica Neue', Arial, sans-serif;
            font-size: 12px;
        }

        .legend {
            position: static;
            /* <-- change this from absolute to static */
            margin-bottom: 10px;
            /* add some breathing room between legends */
        }

        .legend h4 {
            margin: 0 0 10px;
        }

        .legend div span {
            border-radius: 50%;
            display: inline-block;
            height: 10px;
            margin-right: 5px;
            width: 10px;
        }

        /* Nested checkbox styles */
        .overlay-sub-controls {
            margin-left: 20px;
            display: none;
            margin-top: 5px;
            margin-bottom: 5px;
        }

        .overlay-sub-controls.visible {
            display: block;
        }

        .overlay-sub-controls label {
            display: block;
            margin: 3px 0;
        }
    </style>
    <div id="container">
        <div id="layer-controls">
            <label><input type="checkbox" class="layer-toggle" value="Parcels" checked> Parcels</label><br>
            <!-- <label><input type="checkbox" class="layer-toggle" value="Proposed-Zones" checked> Proposed
                zoning</label><br> -->

            <label><input type="checkbox" class="layer-toggle" value="Lot-Sizes-of-Residential-Parcels"> Lot
                size</label><br>
            <!-- <label><input type="checkbox" class="layer-toggle" value="Too-Little-Frontage"> Insufficient
                frontage</label><br> -->
            <label><input type="checkbox" class="layer-toggle"
                    value="Residential-Parcels-Smaller-than-Minimum-Lot-Size"> Insufficient lot size</label><br>
            <label><input type="checkbox" class="layer-toggle" value="Insufficient-Lot-Area-Per-DU"> Insufficient lot area per DU</label><br>
            <!-- <label><input type="checkbox" class="layer-toggle" value="Overlay"> Overlays</label><br> -->
            <!-- <label><input type="checkbox" class="layer-toggle" value="Too-Little-Setback"> Insufficient front
                setback</label><br> -->
            <label><input type="checkbox" class="layer-toggle" value="Usable-Open-Space"> Insufficient usable open space per DU</label><br>
            <label><input type="checkbox" class="layer-toggle" value="Zones" checked> Existing zoning</label><br>
            <label><input type="checkbox" class="layer-toggle" value="Uses"> Existing use</label><br>
            <label><input type="checkbox" class="layer-toggle" value="Variances">Variances</label><br>
            <label><input type="checkbox" id="overlays-parent" class="layer-toggle" value="Overlays">Overlays</label>
            <div id="overlay-sub-controls" class="overlay-sub-controls">
                <label><input type="checkbox" class="overlay-toggle" value="Arts-District"> Arts District</label>
                <label><input type="checkbox" class="overlay-toggle" value="Downtown"> Downtown Overlay</label>
                <label><input type="checkbox" class="overlay-toggle" value="Smart-Growth"> Smart Growth District</label>
                <label><input type="checkbox" class="overlay-toggle" value="High-Rise"> MBTA Multifamily - High Rise</label>
                <label><input type="checkbox" class="overlay-toggle" value="Mid-Rise"> MBTA Multifamily - Mid Rise</label>
                <label><input type="checkbox" class="overlay-toggle" value="Neighborhood"> MBTA Multifamily - Neighborhood</label>
            </div>
        </div>
    </div>
    <div id="map"></div>
    <div id="legend-container"></div>



    <script>
        const lotSizePalette = [ //blue ramp
            '#E2FDFF',
            '#D1EAFF',
            '#BFD7FF',
            '#9BB1FF',
            '#8A9EFF',
            '#788BFF',
            '#5465FF',
            '#333FAC',
            '#1C2790',
            '#0D1667'
        ]

        const uses = [
            "Public/Institutional (including open space)",
            "Single-family",
            "Vacant",
            "Multi-family",
            "Industrial, auto, utility, storage",
            "Three-family",
            "Two-family",
            "Other housing",
            "Commercial",
            "Mixed-use",
            "Other",
            "Recreation"
        ]

        const useLabels = {
            "Public/Institutional (including open space)": "Public/Institutional (including open space)",
            "Single-family": "Single-family",
            "Two-family": "Two-family",
            "Three-family": "Three-family",
            "Multi-family": "Multi-family",
            "Other housing": "Other housing",
            "Hotel": "Hotel",
            "Commercial": "Commercial (retail, office)",
            "Mixed-use": "Mixed-use",
            "Recreation": "Recreation",
            "Industrial, auto, utility, storage": "Industrial, auto, utility, storage",
            "Vacant": "Vacant",
            "Nursing ho": "Public/Institutional (including open space)",
            "Other use": "Other use"
        };

        const useColors = [
            "#d4f088", // green
            "#fff9dc", // light yellow
            "#FFFFFF", // white
            "#f18c1b", // orange
            "#d5d5d5", // gray
            "#f5b72d", // warmest yellow
            "#f4dd63", // yellow
            "#cf820f", // brown
            "#f2b1c2", // pink
            "#d899dd", // fuchsia
            "#767676", // black
            "#8adfa9" // green (again)
        ];

        const usesAndColors = uses.flatMap((use, i) => [use, useColors[i]]);

        // const zones = ['BA', 'BB', 'BC', 'C', 'CR', 'HR1', 'HR2', 'I', 'LC', 'RA1', 'RA2', 'RA3', 'RA4', 'RB', 'RC', 'RD']

        // const zoneColors = [
        //     "#ffb3b3", // BA
        //     "#f26b6b", // BB
        //     "#a82940", // BC
        //     "#f7d8d8", // C
        //     "#bdd66b", // CR
        //     "#0057e7", // HR1
        //     "#734ac3", // HR2
        //     "#b3b3b3", // I
        //     "#b7a4ff", // LC
        //     "#fff9dc", // RA1
        //     "#fff099", // RA2
        //     "#f4dd63", // RA3
        //     "#f5b72d", // RA4
        //     "#f18c1b", // RB
        //     "#c87a12", // RC
        //     "#a55a00"  // RD
        // ];
        const zones = ['SSF', 'SMF', 'SMU', 'RR', 'TSF', 'TTF', 'TMF', 'TMU', 'NB', 'USF', 'UMF', 'UMU', 'DMU', 'HRC', 'INST', 'OP', 'LI', 'GI', 'PDMI', 'HCD']
        const zonesProps = ['B1', 'MU', 'BC', 'C', 'CR', 'HR1', 'HR2', 'I', 'INST', 'C/RD', 'R1', 'R2', 'R3', 'R4']

        const zoneColors = [
            "#fff9dc", // SSF surburban single-family (keep - lightest)
            "#f5b72d", // SMF suburban multi-family (medium orange)
            "#f26b6b", // SMU suburban mixed-use
            "#b7a4ff", // RR regional retail
            "#fff099", // TSF traditional single-family (light yellow)
            "#e6a832", // TTF traditional two-family (orange)
            "#c87a12", // TMF traditional multi-family (dark brown)
            "#9966cc", // TMU traditional mixed-use
            "#ffb3b3", // NB neighborhood business
            "#f4dd63", // USF urban single-family (bright yellow)
            "#a55a00", // UMF urban multi-family (keep - darkest)
            "#cc6699", // UMU urban mixed-use
            "#8b4b8b", // DMU downtown mixed-use
            "#f7d8d8", // HRC high-rise commercial district
            "#bdd66b", // INST institional mixed-use district
            "#87ceeb", // OP office/research park
            '#b3b3b3', // LI light industry
            '#666666', // GI general industry
            '#20b2aa', // PDMI planned development medical/institutional
            '#d2691e'  // HCD hamilton canal district
        ];

        const proposedColors = [
            "#ffb3b3", // B1
            "#f26b6b", // MU
            "#a82940", // BC
            "#f7d8d8", // C
            "#bdd66b", // CR
            "#0057e7", // HR1
            "#734ac3", // HR2
            "#b3b3b3", // I
            "#36adaf", // INST
            "#b7a4ff", // C/RD
            "#fff9dc", // R1
            "#f4dd63", // R2
            "#f5b72d", // R3
            "#c87a12", // R4
        ];

        const varianceColors = [
            "#ff60a5", // P
            "#3c9cfc", // Dim
            "#ffee35", // Dens
            "#b03bfe", // P + Dim
            "#ff9327", // P + Dens
            "#3dcd63", // Dim + Dens
            "#7d7d7d", // P + Dim + Dens
            "#c5c5c5", // Other
    ];


        const zonesAndColors = zones.flatMap((zone, i) => [zone, zoneColors[i]]);
        const zonesAndColorsProps = zonesProps.flatMap((zonesProp, i) => [zonesProp, proposedColors[i]]);

        mapboxgl.accessToken = 'pk.eyJ1Ijoic2FyYWJyZW50IiwiYSI6ImNtMHpsb2Q4NTAwemoybHExbnB6eHVvZ2kifQ.nH0hUSv3IGzX6MkYB_cSmA';
        const map = new mapboxgl.Map({
            container: 'map',
            // Choose from Mapbox's core styles, or make your own style with Mapbox Studio
            style: 'mapbox://styles/communityscale/cmcuwuwcv00xz01s1gn7xccqi',
            zoom: 12.7,
            center: [-71.3162, 42.6334],
            projection: 'globe'
        });

        const lotSizeBreakpoints = [0, 4000, 5000, 6000, 7000, 8000, 9000, 10000, 15000, 20000];
        const legendEntries = {
            // 'Too-Little-Setback': [
            //     { color: 'rgba(0, 0, 0, .2)', label: 'Front setback shallower than required by zone' }
            // ],
            'Usable-Open-Space': [
                { color: 'rgba(0, 0, 0, .2)', label: 'Not enough usable open space per dwelling unit' }
            ],
            // 'Too-Little-Frontage': [
            //     { color: 'black', label: 'Frontage narrower than required by zone' }
            // ],
            'Residential-Parcels-Smaller-than-Minimum-Lot-Size': [
                { color: 'rgba(0, 0, 0, .2)', label: 'Lot smaller than required by zone' }
            ],
            'Insufficient-Lot-Area-Per-DU': [
                { color: 'rgba(0, 0, 0, .2)', label: 'Insufficient lot area per dwelling unit' }
            ],
            'Lot-Sizes-of-Residential-Parcels': [
                { color: lotSizePalette[0], label: 'Smaller than 4,000 sqft' },
                { color: lotSizePalette[1], label: '4,000-5,000 sqft' },
                { color: lotSizePalette[2], label: '5,000-6,000 sqft' },
                { color: lotSizePalette[3], label: '6,000-7,000 sqft' },
                { color: lotSizePalette[4], label: '7,000-8,000 sqft' },
                { color: lotSizePalette[5], label: '8,000-9,000 sqft' },
                { color: lotSizePalette[6], label: '9,000-10,000 sqft' },
                { color: lotSizePalette[7], label: '10,000-15,000 sqft' },
                { color: lotSizePalette[8], label: '15,000-20,000 sqft' },
                { color: lotSizePalette[9], label: '20,000+ sqft' }
            ],
            'Zones': zones.map((zone, i) => ({
                color: zoneColors[i],
                label: zone
            })),
            // 'Proposed-Zones': zonesProps.map((zonesProp, i) => ({
            //     color: proposedColors[i],
            //     label: zonesProp
            // })),
            'Uses': [
                { color: useColors[1], label: 'Single-family' },
                { color: useColors[6], label: 'Two-family' },
                { color: useColors[5], label: 'Three-family' },
                { color: useColors[3], label: 'Multi-family' },
                { color: useColors[7], label: 'Other housing' },
                { color: useColors[8], label: 'Commercial' },
                { color: useColors[9], label: 'Mixed-use' },
                { color: useColors[11], label: 'Recreation' },
                { color: useColors[4], label: 'Industrial, auto, utility, storage' },
                { color: useColors[0], label: 'Public/Institutional (including open space)' },
                { color: useColors[2], label: 'Vacant' },
                { color: useColors[10], label: 'Other use' },
            ],

            'Variances': [
                { color: varianceColors[0], label: 'Parking', type: 'circle' },
                { color: varianceColors[1], label: 'Dimensional', type: 'circle' },
                { color: varianceColors[2], label: 'Density', type: 'circle' },
                { color: varianceColors[3], label: 'Parking & Dimensional', type: 'circle' },
                { color: varianceColors[4], label: 'Parking & Density', type: 'circle' },
                { color: varianceColors[5], label: 'Dimensional & Density', type: 'circle' },
                { color: varianceColors[6], label: 'Parking, Dimensional, & Density', type: 'circle' },
                { color: varianceColors[7], label: 'Other', type: 'circle' },
            ],

            'Overlays': [
                 { color: 'aqua', label: 'Arts District'},
                 { color: 'blue', label: 'Downtown Overlay'},
                 { color: 'lime', label: 'Smart Growth District' },
                 { color: 'red', label: 'MBTA Multifamily - High Rise' },
                 { color: 'orange', label: 'MBTA Multifamily - Mid Rise' },
                 { color: 'yellow', label: 'MBTA Multifamily - Neighborhood' }
             ]
        };

                    let labelLayerId; //pull text fields on top!!
                map.on('style.load', () => {
            const layers = map.getStyle().layers;
            for (const layer of layers) {
                if (layer.type === 'symbol' && layer.layout && layer.layout['text-field']) {
                    labelLayerId = layer.id;
                    break;
                }
            }
        });
        map.on('load', () => {
            // Set the default atmosphere style
            map.setFog({});
 
            map.addSource('mapillary', {
                'type': 'vector',
                'tiles': [
                    'https://tiles.mapillary.com/maps/vtp/mly1_public/2/{z}/{x}/{y}?access_token=MLY|4142433049200173|72206abe5035850d6743b23a49c41333'
                ],
                'minzoom': 8,
                'maxzoom': 14
            })


            // map.addSource('frontage', {
            //     type: 'geojson',
            //     data: 'https://raw.githubusercontent.com/CommunityScale/bucket/295f52b99d3948e011b175e39838fb50cbcf8a8a/parcel-segments.geojson'
            // });

            // map.addSource('hydro', {
            //     type: 'geojson',
            //     data: 'hydrowalth.geojson'
            // });

            map.addSource('Boundary', {
                type: 'geojson',
                data: 'https://media.githubusercontent.com/media/CommunityScale/Lowell/main/lowell_outline.geojson'
            });

            map.addSource('allparcels', {
                type: 'geojson',
                data: 'https://media.githubusercontent.com/media/CommunityScale/Lowell/main/allparcels.geojson',
                promoteId: "LOC_ID"
            });

            map.addSource('lowellvariances', {
                type: 'geojson',
                data: 'https://media.githubusercontent.com/media/CommunityScale/Lowell/main/lowellvariances.geojson',
            });

            map.addSource('overlays', {
                 type: 'geojson',
                 data: 'https://media.githubusercontent.com/media/CommunityScale/Lowell/main/lowelloverlays2.geojson'
             });

            // map.addSource('proposedzone', {
            //     type: 'geojson',
            //     data: 'ProposedZone_25_08_15.geojson'
            // });

            // map.addSource('water', {
            //     type: 'geojson',
            //     data: 'https://raw.githubusercontent.com/CommunityScale/Waltham/refs/heads/main/water2.geojson'
            // });

            // map.addSource('coverfront', {
            //     type: 'geojson',
            //     data: 'https://raw.githubusercontent.com/CommunityScale/Waltham/refs/heads/main/coverfront.geojson'
            // });

            map.addLayer({
                id: 'Uses',
                type: 'fill',
                source: 'allparcels',
                paint: {
                    'fill-color': ['match', ['string', ['get', 'UseCategory']], ...usesAndColors, '#AAAAAA'],
                    'fill-opacity': [
                        "case",
                        ["boolean", ["feature-state", "hover"], false],
                        0.5,
                        1],
                }
            }, labelLayerId);

            map.addLayer({
                id: 'Zones',
                type: 'fill',
                source: 'allparcels',
                paint: {
                    'fill-color': ['match', ['string', ['get', 'ZONE']], ...zonesAndColors, '#AAAAAA'],
                    'fill-opacity': [
                        "case",
                        ["boolean", ["feature-state", "hover"], false],
                        0.5,
                        1]
                }
            }, labelLayerId
            );

            // map.addLayer({
            //     id: 'Proposed-Zones',
            //     type: 'fill',
            //     source: 'proposedzone',
            //     paint: {
            //         'fill-color': ['match', ['string', ['get', 'PropZo1']], ...zonesAndColorsProps, '#AAAAAA'],
            //         'fill-opacity': [
            //             "case",
            //             ["boolean", ["feature-state", "hover"], false],
            //             0.5,
            //             1]
            //     }
            // }, labelLayerId
            // );

            map.addLayer({
                id: 'Lot-Sizes-of-Residential-Parcels',
                type: 'fill',
                source: 'allparcels',
                paint: {
                    'fill-outline-color': 'white',
                    'fill-color': [
                        "case", ["==", ["get", "res_lot_size_sf"], null], 'white',
                        ["interpolate",
                            ["linear"],
                            ["get", "res_lot_size_sf"],
                            0,
                            lotSizePalette[0],
                            4000,
                            lotSizePalette[1],
                            5000,
                            lotSizePalette[2],
                            6000,
                            lotSizePalette[3],
                            7000,
                            lotSizePalette[4],
                            8000,
                            lotSizePalette[5],
                            9000,
                            lotSizePalette[6],
                            10000,
                            lotSizePalette[7],
                            15000,
                            lotSizePalette[8],
                            20000,
                            lotSizePalette[9]
                        ]],
                    'fill-opacity': [
                        "case",
                        ["boolean", ["feature-state", "hover"], false],
                        0.5,
                        1],
                }
            }, labelLayerId);

            map.addLayer({
                id: 'Residential-Parcels-Smaller-than-Minimum-Lot-Size',
                type: 'fill',
                source: 'allparcels',
                paint: {
                    'fill-color': [
                        'match',
                        ['get', 'res_ncf_min_lot_size'],
                        '1', 'rgba(0, 0, 0, .25)',  // String "1" instead of number 1
                        'rgba(0, 0, 0, 0)'
                    ]
                }
            }, labelLayerId);


            map.addLayer({
                id: 'Insufficient-Lot-Area-Per-DU',
                type: 'fill',
                source: 'allparcels',
                paint: {
                    'fill-color': [
                        'match',
                        ['get', 'res_ncf_min_lot_area_per_du'],
                        '1', 'rgba(0, 0, 0, .25)',  // String "1" instead of number 1
                        'rgba(0, 0, 0, 0)'
                    ]
                }
            }, labelLayerId);

            // map.addLayer({
            //     id: 'hydro',
            //     type: 'fill',
            //     source: 'hydro',
            //     paint: {
            //         'fill-color': '#d9eaf0'
            //     }

            // }, labelLayerId);
            
            map.addLayer({
                id: 'Parcels',
                type: 'fill',
                source: 'allparcels',
                paint: {
                    'fill-outline-color': '#828282',
                    'fill-color': 'transparent',
                    'fill-opacity': 1,
                }
            }, labelLayerId);

            // map.addLayer({
            //     id: 'Too-Little-Frontage',
            //     type: 'line',
            //     source: 'frontage',
            //     paint: {
            //         'line-width': 4,
            //         'line-color': [
            //             'match',
            //             ['get', 'ncf_min_frontage'],
            //             1, 'black',
            //             'transparent' // default fallback color
            //         ],
            //     }
            // }, labelLayerId);

            map.addLayer({
                id: 'Usable-Open-Space',
                type: 'fill',
                source: 'allparcels',
                paint: {
                    'fill-color': [
                        'match',
                        ['get', 'res_ncf_min_uos_per_du'],
                        '1', 'rgba(0, 0, 0, .25)',  // String "1" instead of number 1
                        'rgba(0, 0, 0, 0)'
                    ]
                }
            }, labelLayerId);

            // map.addLayer({
            //     id: 'Too-Little-Setback',
            //     type: 'fill',
            //     source: 'coverfront',
            //     paint: {
            //         'fill-color': [
            //             'match',
            //             ['get', 'WalthamBuildingsv2_TooLilSB'],
            //             "1", 'rgba(0, 0, 0, .25)',
            //             'rgba(0, 0, 0, 0)' // default fallback color
            //         ]
            //     }
            // }, labelLayerId);


                           // Overlays with hatched fills for MBTA layers
            // High Rise - hatched fill
            map.addLayer({
                id: 'Overlays-High-Rise-Fill',
                type: 'fill',
                source: 'overlays',
                filter: ['==', ['get', 'Name'], 'MBTA Multifamily - High Rise'],
                paint: {
                    'fill-color': 'red',
                    'fill-opacity': 0.6
                }
            }, labelLayerId);

            // High Rise - outline
            map.addLayer({
                id: 'Overlays-High-Rise-Line',
                type: 'line',
                source: 'overlays',
                filter: ['==', ['get', 'Name'], 'MBTA Multifamily - High Rise'],
                paint: {
                    'line-color': 'red',
                    'line-width': 3
                }
            }, labelLayerId);

            // Neighborhood - hatched fill
            map.addLayer({
                id: 'Overlays-Neighborhood-Fill',
                type: 'fill',
                source: 'overlays',
                filter: ['==', ['get', 'Name'], 'MBTA Multifamily - Neighborhood'],
                paint: {
                    'fill-color': 'yellow',
                    'fill-opacity': 0.6
                }
            }, labelLayerId);

            // Neighborhood - outline
            map.addLayer({
                id: 'Overlays-Neighborhood-Line',
                type: 'line',
                source: 'overlays',
                filter: ['==', ['get', 'Name'], 'MBTA Multifamily - Neighborhood'],
                paint: {
                    'line-color': 'yellow',
                    'line-width': 3
                }
            }, labelLayerId);

            // Mid Rise - hatched fill
            map.addLayer({
                id: 'Overlays-Mid-Rise-Fill',
                type: 'fill',
                source: 'overlays',
                filter: ['==', ['get', 'Name'], 'MBTA Multifamily - Mid Rise'],
                paint: {
                    'fill-color': 'orange',
                    'fill-opacity': 0.6
                }
            }, labelLayerId);

            // Mid Rise - outline
            map.addLayer({
                id: 'Overlays-Mid-Rise-Line',
                type: 'line',
                source: 'overlays',
                filter: ['==', ['get', 'Name'], 'MBTA Multifamily - Mid Rise'],
                paint: {
                    'line-color': 'orange',
                    'line-width': 3
                }
            }, labelLayerId);

            // Other overlays (Arts District, Downtown, Smart Growth) - just lines
            // Arts District
            map.addLayer({
                id: 'Overlays-Arts-District',
                type: 'line',
                source: 'overlays',
                filter: ['==', ['get', 'Name'], 'Arts District'],
                paint: {
                    'line-color': 'aqua',
                    'line-width': 3
                }
            }, labelLayerId);

            // Downtown Overlay
            map.addLayer({
                id: 'Overlays-Downtown',
                type: 'line',
                source: 'overlays',
                filter: ['==', ['get', 'Name'], 'Downtown Overlay'],
                paint: {
                    'line-width': 3,
                    'line-color': 'blue'
                }
            }, labelLayerId);

            // Smart Growth District
            map.addLayer({
                id: 'Overlays-Smart-Growth',
                type: 'line',
                source: 'overlays',
                filter: ['==', ['get', 'Name'], 'Smart Growth District'],
                paint: {
                    'line-width': 3,
                    'line-color': 'lime'
                }
            }, labelLayerId);



            map.addLayer({
                id: 'Boundary',
                type: 'line',
                source: 'Boundary',
                paint: {
                    'line-width': 2,
                    'line-color': 'black',
                }
            }, labelLayerId);

             map.addLayer({
                id: 'Variances',
                type: 'circle',
                source: 'lowellvariances',
                paint: {
                    'circle-color': [
                        'match',
                        ['get', 'code'],
                        1, varianceColors[0],
                        2, varianceColors[1],
                        3, varianceColors[2],
                        4, varianceColors[3],
                        5, varianceColors[4],
                        6, varianceColors[5],
                        7, varianceColors[6],
                        8, varianceColors[7],
                        '#999999'  // fallback
            ],
                    'circle-radius': 5,
                    'circle-stroke-width': 1,
                    'circle-stroke-color': 'black',
                }
            }, labelLayerId);

            window.addEventListener('resize', () => {
                map.resize();
            });

            // map.setLayoutProperty('Too-Little-Frontage', 'visibility', 'none');
            map.setLayoutProperty('Residential-Parcels-Smaller-than-Minimum-Lot-Size', 'visibility', 'none');
            map.setLayoutProperty('Insufficient-Lot-Area-Per-DU', 'visibility', 'none');
            map.setLayoutProperty('Lot-Sizes-of-Residential-Parcels', 'visibility', 'none');
            map.setLayoutProperty('Usable-Open-Space', 'visibility', 'none');
            // map.setLayoutProperty('Too-Little-Setback', 'visibility', 'none');
            // map.setLayoutProperty('Zones', 'visibility', 'none');
            // map.setLayoutProperty('Overlay', 'visibility', 'none');
            map.setLayoutProperty('Uses', 'visibility', 'none');
            map.setLayoutProperty('Variances', 'visibility', 'none');
            
            // Set all overlay layers to none initially
            map.setLayoutProperty('Overlays-High-Rise-Fill', 'visibility', 'none');
            map.setLayoutProperty('Overlays-High-Rise-Line', 'visibility', 'none');
            map.setLayoutProperty('Overlays-Neighborhood-Fill', 'visibility', 'none');
            map.setLayoutProperty('Overlays-Neighborhood-Line', 'visibility', 'none');
            map.setLayoutProperty('Overlays-Mid-Rise-Fill', 'visibility', 'none');
            map.setLayoutProperty('Overlays-Mid-Rise-Line', 'visibility', 'none');
            map.setLayoutProperty('Overlays-Arts-District', 'visibility', 'none');
            map.setLayoutProperty('Overlays-Downtown', 'visibility', 'none');
            map.setLayoutProperty('Overlays-Smart-Growth', 'visibility', 'none');
            
            map.setLayoutProperty('settlement-major-label', 'visibility', 'visible');
            map.setLayoutProperty('settlement-subdivision-label', 'visibility', 'visible');
            map.setLayoutProperty('settlement-minor-label', 'visibility', 'visible');
            // map.moveLayer('road-label', 'Zones');
           


            const checkboxes = document.querySelectorAll('.layer-toggle');

            // Overlay layer mappings
            const overlayLayerMap = {
                'Arts-District': ['Overlays-Arts-District'],
                'Downtown': ['Overlays-Downtown'],
                'Smart-Growth': ['Overlays-Smart-Growth'],
                'High-Rise': ['Overlays-High-Rise-Fill', 'Overlays-High-Rise-Line'],
                'Mid-Rise': ['Overlays-Mid-Rise-Fill', 'Overlays-Mid-Rise-Line'],
                'Neighborhood': ['Overlays-Neighborhood-Fill', 'Overlays-Neighborhood-Line']
            };

            // Handle parent Overlays checkbox
            const overlaysParent = document.getElementById('overlays-parent');
            const overlaySubControls = document.getElementById('overlay-sub-controls');
            const overlayToggles = document.querySelectorAll('.overlay-toggle');

            overlaysParent.addEventListener('change', () => {
                if (overlaysParent.checked) {
                    overlaySubControls.classList.add('visible');
                } else {
                    overlaySubControls.classList.remove('visible');
                    // Uncheck and hide all sub-overlays
                    overlayToggles.forEach(toggle => {
                        toggle.checked = false;
                        const layers = overlayLayerMap[toggle.value];
                        if (layers) {
                            layers.forEach(layerId => {
                                if (map.getLayer(layerId)) {
                                    map.setLayoutProperty(layerId, 'visibility', 'none');
                                }
                            });
                        }
                    });
                }
            });

            // Handle individual overlay toggles
            overlayToggles.forEach(toggle => {
                toggle.addEventListener('change', () => {
                    const visibility = toggle.checked ? 'visible' : 'none';
                    const layers = overlayLayerMap[toggle.value];
                    
                    if (layers) {
                        layers.forEach(layerId => {
                            if (map.getLayer(layerId)) {
                                map.setLayoutProperty(layerId, 'visibility', visibility);
                            }
                        });
                    }
                });
            });

            const legends = {
                // 'Too-Little-Frontage': 'frontageLegend',
                'Residential-Parcels-Smaller-than-Minimum-Lot-Size': 'toosmallLegend',
                'Lot-Sizes-of-Residential-Parcels': 'lotsizeLegend',
                // 'Too-Little-Setback': 'toolittleSetbackLegend',
                'Usable-Open-Space': 'toomuchCoverageLegend',
                'Zones': 'existzoneLegend',
                // 'Overlay': 'overlayLegend'
                // 'Proposed Zones': 'proposedLegend'
                'Uses': 'useLegend'
            };

            checkboxes.forEach((checkbox) => {
                checkbox.addEventListener('change', () => {
                    const layerId = checkbox.value;
                    
                    // Skip Overlays parent - it's handled separately
                    if (layerId === 'Overlays') {
                        return;
                    }
                    
                    const visibility = checkbox.checked ? 'visible' : 'none';
                    if (map.getLayer(layerId)) {
                        map.setLayoutProperty(layerId, 'visibility', visibility);
                        map.setLayoutProperty('settlement-major-label', 'visibility', 'visible');
                        map.setLayoutProperty('settlement-subdivision-label', 'visibility', 'visible');
                        map.setLayoutProperty('settlement-minor-label', 'visibility', 'visible');
                        // map.setLayoutProperty('road-label', 'visibility', 'visible');
                    }

                    // Instead of trying to show/hide predefined legends, let's dynamically rebuild
                    const legendContainer = document.getElementById('legend-container');
                    legendContainer.innerHTML = ''; // Clear all

                    Array.from(checkboxes).forEach(cb => {
                        if (cb.checked && legendEntries[cb.value]) {
                            const entries = legendEntries[cb.value];

                            const legendSection = document.createElement('div');
                            legendSection.className = 'legend';

                            const title = document.createElement('h4');
                            title.textContent = cb.value.replace(/-/g, ' ');
                            legendSection.appendChild(title);

                            entries.forEach(entry => {
                                const item = document.createElement('div');
                                item.innerHTML = `
                        <span style="background:${entry.color};"></span>${entry.label}
                    `;
                                legendSection.appendChild(item);
                            });

                            legendContainer.appendChild(legendSection);
                        }
                    });
                });
            });

            function rebuildLegend() {
                const legendContainer = document.getElementById('legend-container');
                legendContainer.innerHTML = ''; // Clear all

                Array.from(checkboxes).forEach(cb => {
                    if (cb.checked && legendEntries[cb.value]) {
                        const entries = legendEntries[cb.value];

                        const legendSection = document.createElement('div');
                        legendSection.className = 'legend';

                        const title = document.createElement('h4');
                        title.textContent = cb.value.replace(/-/g, ' ');
                        legendSection.appendChild(title);

                        entries.forEach(entry => {
                            const item = document.createElement('div');
                            item.innerHTML = `
                    <span style="background:${entry.color};"></span>${entry.label}
                `;
                            legendSection.appendChild(item);
                        });

                        legendContainer.appendChild(legendSection);
                    }
                });
            }

            // 1. Rebuild legends when page loads
            rebuildLegend();

            // 2. Also rebuild legends when user checks/unchecks
            checkboxes.forEach((checkbox) => {
                checkbox.addEventListener('change', () => {
                    const layerId = checkbox.value;
                    const visibility = checkbox.checked ? 'visible' : 'none';
                    if (map.getLayer(layerId)) {
                        map.setLayoutProperty(layerId, 'visibility', visibility);
                    }
                    rebuildLegend(); // Refresh the legend dynamically
                });
            });

            let hoveredGeoId = null;


            const hoverLayers = [
                { id: 'Zones', source: 'allparcels' },
                { id: 'Lot-Sizes-of-Residential-Parcels', source: 'allparcels' },
                { id: 'Uses', source: 'allparcels' }
            ];

            hoverLayers.forEach(({ id, source }) => {
                map.on('mousemove', id, (e) => {
                    if (e.features.length > 0) {
                        if (hoveredGeoId !== null) {
                            map.setFeatureState(
                                { source, id: hoveredGeoId },
                                { hover: false }
                            );
                        }
                        hoveredGeoId = e.features[0].id;
                        map.setFeatureState(
                            { source, id: hoveredGeoId },
                            { hover: true }
                        );
                    }
                });

                map.on('mouseleave', id, () => {
                    if (hoveredGeoId !== null) {
                        map.setFeatureState(
                            { source, id: hoveredGeoId },
                            { hover: false }
                        );
                    }
                    hoveredGeoId = null;
                });
            });



            map.on('click', (e) => {
                const [selectedParcel] = map.queryRenderedFeatures(e.point, {
                    layers: ["Zones", "Lot-Sizes-of-Residential-Parcels"]
                });

                if (selectedParcel) {
                    function sliceStringBySpaces(str, numSpaces) {
                        const words = str.split(" ");
                        const slicedWords = words.slice(0, numSpaces);
                        return slicedWords.join(" ");
                    }

                    const address = selectedParcel.properties.SiteAddress.replace(/,/g, "");
                    const num = 4;
                    const result = sliceStringBySpaces(address, num);

                    const zone = selectedParcel.properties.ZONE;
                    const displayZone = zone === null || zone === undefined ? 'No available data' : `Zoning district: ${zone}`;
                    const use = selectedParcel.properties.UseCategory;
                    // const useDescription = useLabels[use] || "Unknown use";
                    const displayUse = use === null || use === undefined ? 'Unknown' : `Current use: ${use}`;
                    const lotSize = selectedParcel.properties.res_lot_size_sf;
                    const roundedLotSize = Math.round(lotSize)
                    const displaySize = lotSize === null || lotSize === undefined ? 'Lot size: No data' : `Lot size: ${roundedLotSize.toLocaleString("en-US")} square feet`;


                    new mapboxgl.Popup({ closeButton: true }, { clickToClose: true })
                        .setLngLat(selectedParcel.geometry.coordinates[0][0])
                        .setHTML(`
                <div class="mapboxgl-popup">
                <div class="mapboxgl-popup-close-button">x</div>
                <div class="mapboxgl-popup-header">${result}</div>
                <div class="mapboxgl-popup-content">${displayZone}<br>${displayUse}<br>${displaySize}
                </div>
            </div>`)
                        .addTo(map);
                }
            });

        });


    </script>

</body>

</html>